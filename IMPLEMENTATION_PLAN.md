# ナショナルエコノミー・メセナ 実装計画

## 家計システムの理解

### 【家計】と【サプライ】の違い

- **サプライ (supply)**: ゲーム外のお金置き場
  - 建物売却時のみここからお金を取得
  - ゲーム終了時のスコア計算には影響しない
- **家計 (household)**: ゲーム内で流通する共有のお金置き場
  - ラウンド終了時の賃金支払いは家計に支払う
  - 露店・市場・スーパー・百貨店などの職場効果で家計からお金を獲得
  - 両替時も家計とサプライの総量は変わらないように管理

　　
**現在の実装状態**: ✅ 実装済み

- `GameState.household` と `GameState.supply` で管理
- 各職場効果で `this.household` からの取得を実装済み

---

## 必須実装項目　

### 1. 勝利点トークンシステム

**状態**: 🔴 未実装

**仕様**:

- プレイヤーごとに勝利点トークン数を管理 (`Player.victoryTokens`)
- 獲得方法: 菜園・研究所・宮大工の職場効果
- 得点計算: 3枚ごとに10点、3枚に満たない分は1枚につき1点
  - 例: 4枚 = 10 + 1 = 11点、6枚 = 20点

**実装内容**:

- `Player` 型に `victoryTokens: number` を追加 ✅ 済み
- CardDefs に菜園・研究所・宮大工を追加し、effect を設定
- GameState に `gain_victory_token` 効果を実装
- ゲーム終了時スコア計算に勝利点計算を追加

---

### 2. 変動建設コストシステム

**状態**: 🔴 未実装

**仕様**:

- 条件を満たすと建設コストが削減される建物
- カードの左上に緑の矢印マークが付く
- 建物ごとに条件と削減幅が異なる

**実装内容**:

- `Card` 型に `costReduction?: { condition: string, amount: number }` を追加
- 建設時に条件をチェックしてコストを計算
- UI で緑矢印を表示

---

### 3. 初期手札3枚配布

**状態**: 🔴 未実装

**仕様**:

- ゲーム開始時に各プレイヤーに建物カード3枚を配る

**実装内容**:

- `GameState.initializeGame()` または `dealInitialCards()` で3枚配布
- 現在は手札配布なしなので追加が必要

---

### 4. 手札上限5枚制限

**状態**: 🔴 未実装

**仕様**:

- ラウンド終了時に手札6枚以上のプレイヤーは5枚になるように選んで捨てる
- スタートプレイヤーから順に実施

**実装内容**:

- `GameState.endRound()` に手札チェック処理を追加
- クライアント側で捨てるカードを選択する UI を実装
- WebSocket で `discard_excess_cards` アクションを追加

---

### 5. 未払い賃金システム

**状態**: 🔴 未実装

**仕様**:

- 賃金支払い不足時、不足額1ドルにつき未払い賃金カード1枚を取得
- ゲーム終了時に1枚につき-3点

**実装内容**:

- `Player` 型に `unpaidWages: number` を追加 ✅ 済み (unpaidDebt として存在)
- `GameState.endRound()` で賃金支払い不足時の処理を実装
- ゲーム終了時スコア計算に `-unpaidWages * 3` を追加

---

### 6. 建物売却処理の修正

**状態**: ⚠️ 部分実装

**仕様**:

- 賃金不足時のみ売却可能（お金が足りている時は売却不可）
- 売却額は資産価値と同額をサプライから取得
- 売却した建物は公共職場に移動し、次ラウンドから全員が使用可能

**実装内容**:

- `GameState.endRound()` の賃金支払い処理を修正
- 売却時に `this.supply` から資産価値を取得
- 売却した建物を `this.publicCards` に追加

---

### 7. ゲーム終了時スコア計算

**状態**: 🔴 未実装

**仕様**:

```
スコア = 建物資産価値
       + 終了時ボーナス（建物の「終了時」効果）
       + 所持金（$1 = 1点）
       + 勝利点トークン（3枚ごとに10点、端数1枚1点）
       - 未払い賃金（1枚3点）
```

**同点時の処理**:

1. スタートプレイヤーが勝者
2. いなければ手番順がスタートプレイヤーに近い方が勝者

**実装内容**:

- `GameState.calculateFinalScores()` メソッドを実装
- 各要素のスコアを計算して返す
- 同点処理を実装

---

### 8. 研修中労働者の正しい実装

**状態**: ⚠️ 部分実装

**仕様**:

- 新規雇用時は表を「研修中」の状態で配置
- 研修中は賃金が発生するが仕事はできない（労働者として配置不可）
- 次のラウンド開始時に裏返して正式な労働者になる

**現在の問題**:

- `trainingWorkers` はあるが、配置制限が未実装
- ラウンド開始時の正式化処理が未実装

**実装内容**:

- `placeWorker()` で `player.workers` のみチェック（trainingWorkers は除外）
- `endRound()` の賃金計算で `workers + trainingWorkers` を使用 ✅ 済み
- ラウンド開始時またはラウンド終了後に `trainingWorkers` を `workers` に移動

---

## UI 改善項目

### 9. ゲーム情報表示の拡充

**状態**: 🔴 未実装

**画面表示項目**:

```
ラウンド 1 | 賃金: $2/人 | 家計: $X | サプライ: $X
```

**実装内容**:

- `GameRoom.tsx` で household と supply を表示
- WebSocket で state 送信時に household と supply を含める

---

## 実装優先順位

### Phase 1: コアシステム（必須）

1. ✅ 家計・サプライシステム（実装済み）
2. 初期手札3枚配布
3. 研修中労働者の正しい実装
4. 手札上限5枚制限
5. 未払い賃金システム
6. 建物売却処理の修正

### Phase 2: 得点システム

7. 勝利点トークンシステム
8. ゲーム終了時スコア計算

### Phase 3: 高度な機能

9. 変動建設コストシステム
10. UI 改善（家計・サプライ表示）

---

## 実装メモ

### 家計の流れ

1. **ゲーム開始**: household = 0
2. **ラウンド終了**: 各プレイヤーが賃金を家計に支払う → household 増加
3. **職場効果**: 露店・市場など使用時 → household から取得 → household 減少
4. **建物売却**: サプライから取得（家計ではない）

### 賃金支払いフロー

```
ラウンド終了
↓
労働者を手元に戻す
↓
賃金計算: (workers + trainingWorkers) × 現在ラウンドの賃金
↓
所持金 >= 賃金?
  YES → 家計に支払い
  NO  → 建物売却を繰り返す
    ↓
    まだ足りない?
      YES → 未払い賃金カード取得
      NO  → 家計に支払い
↓
手札6枚以上? → 5枚まで捨てる
↓
次ラウンド開始
```

### 研修中労働者のフロー

```
学校で労働者雇用
↓
trainingWorkers++ （研修中として追加）
↓
このラウンド: 配置不可、賃金は発生
↓
ラウンド終了 → 次ラウンド開始
↓
trainingWorkers を workers に移動
↓
次ラウンド: 配置可能
```
